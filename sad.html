<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <title>Dot density | Sample | ArcGIS API for JavaScript 4.24</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/light/main.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" href="src/input.css">
    <link rel="stylesheet" href="https://js.arcgis.com/4.24/esri/themes/dark/main.css" />
    <script src="https://js.arcgis.com/4.24/"></script>

    <!-- INITIAL MAP -->
    <!-- <script>
      require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/renderers/DotDensityRenderer",
        "esri/widgets/Legend",
        "esri/widgets/Bookmarks",
        "esri/widgets/Expand"
      ], (WebMap, MapView, FeatureLayer, DotDensityRenderer, Legend, Bookmarks, Expand) => {
        const map = new WebMap({
          portalItem: {
            id: "56b5bd522c52409c90d902285732e9f1"
          }
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          highlightOptions: {
            fillOpacity: 0,
            color: [50, 50, 50]
          },
          popup: {
            dockEnabled: true,
            dockOptions: {
              position: "top-right",
              breakpoint: false
            }
          },
          constraints: {
            maxScale: 35000
          }
        });

        view.when().then(() => {
          const dotDensityRenderer = new DotDensityRenderer({
            dotValue: 100,
            outline: null,
            referenceScale: 577790,  // 1:577,790 view scale
            legendOptions: {
              unit: "people"
            },
            attributes: [
            {
                field: "B03002_003E",
                color: "#f23c3f",
                label: "Rain Occurance"
              },
              {
                field: "B03002_012E",
                color: "#e8ca0d",
                label: "Heavy rain"
              },
              {
                field: "B03002_004E",
                color: "#00b6f1",
                label: "Moderate rain"
              },
              {
                field: "B03002_006E",
                color: "#32ef94",
                label: "Light rain"
              },
              {
                field: "B03002_005E",
                color: "#ff7fe9",
                label: "Traffic frequency"
              },
              {
                field: "B03002_007E",
                color: "#e2c4a5",
                label: "Heavy traffic"
              },
              {
                field: "B03002_008E",
                color: "#ff6a00",
                label: "Moderate traffic"
              },
              {
                field: "B03002_009E",
                color: "#96f7ef",
                label: "Light traffic"
              }
            ]
          });

          // Add renderer to the layer and define a popup template
          const url =
            "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/ACS_Population_by_Race_and_Hispanic_Origin_Boundaries/FeatureServer/2";
          const layer = new FeatureLayer({
            url: url,
            minScale: 20000000,
            maxScale: 35000,
            title: "Current Population Estimates (ACS)",
            popupTemplate: {
              title: "{County}, {State}",
              content: [
              {
                  type: "media",
                  mediaInfos: [
                    {
                      title: "Current Population Estimates (ACS)",
                      type: "bar-chart",
                      value: {
                        fields: [
                          "B03002_003E",
                          "B03002_012E",
                          "B03002_004E",
                          "B03002_006E",
                          "B03002_005E",
                          "B03002_007E",
                          "B03002_008E",
                          "B03002_008E",
                          "B03002_009E"
                        ],
                        tooltipField: "<field name>"
                      }
                    }
                  ]
                },
                {
                  type: "fields",
                }
              ],
              fieldInfos: [
                {
                  fieldName: "B03002_003E",
                  label: "Rain Occurance",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_012E",
                  label: "Heavy rain",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_004E",
                  label: "Moderate rain",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_006E",
                  label: "Light rain",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_005E",
                  label: "Traffic frequency",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_007E",
                  label: "Heavy traffic",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_008E",
                  label: "Moderate traffic",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_009E",
                  label: "Light traffic",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  }   }
              ]
            },
            renderer: dotDensityRenderer
          });

          map.add(layer);

          view.ui.add(
            [
              new Expand({
                view: view,
                content: new Legend({ view: view }),
                group: "top-left",
                expanded: true
              }),
              new Expand({
                view: view,
                content: new Bookmarks({ view: view }),
                group: "top-left"
              })
            ],
            "top-left"
          );
        });
      });
    </script> -->

    <script>
      require([
        "esri/WebMap",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/renderers/DotDensityRenderer",
        "esri/widgets/Legend",
        "esri/widgets/Bookmarks",
        "esri/widgets/Expand"
      ], (WebMap, MapView, FeatureLayer, DotDensityRenderer, Legend, Bookmarks, Expand) => {
        const map = new WebMap({
          portalItem: {
            id: "56b5bd522c52409c90d902285732e9f1"
          }
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          highlightOptions: {
            fillOpacity: 0,
            color: [50, 50, 50]
          },
          popup: {
            dockEnabled: true,
            dockOptions: {
              position: "top-right",
              breakpoint: false
            }
          },
          constraints: {
            maxScale: 35000
          }
        });

        view.when().then(() => {
          const dotDensityRenderer = new DotDensityRenderer({
            dotValue: 100,
            outline: null,
            referenceScale: 577790,  // 1:577,790 view scale
            legendOptions: {
              unit: "mm"
            },
            attributes: [
              {
                field: "B03002_003E",
                color: "#f23c3f",
                label: "Rain Occurance"
              },
              {
                field: "B03002_012E",
                color: "#e8ca0d",
                label: "Heavy rain"
              },
              {
                field: "B03002_004E",
                color: "#00b6f1",
                label: "Moderate rain"
              },
              {
                field: "B03002_006E",
                color: "#32ef94",
                label: "Light rain"
              },
              {
                field: "B03002_005E",
                color: "#ff7fe9",
                label: "Traffic frequency"
              },
              {
                field: "B03002_007E",
                color: "#e2c4a5",
                label: "Heavy traffic"
              },
              {
                field: "B03002_008E",
                color: "#ff6a00",
                label: "Moderate traffic"
              },
              {
                field: "B03002_009E",
                color: "#96f7ef",
                label: "Light traffic"
              }
            ]
          });

          // Add renderer to the layer and define a popup template
          const url =
            "https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/ACS_Population_by_Race_and_Hispanic_Origin_Boundaries/FeatureServer/2";
          const layer = new FeatureLayer({
            url: url,
            minScale: 20000000,
            maxScale: 35000,
            title: "Rainfall Distribution",
            popupTemplate: {
              title: "{County}, {State}",
              content: [
              {
                  type: "media",
                  mediaInfos: [
                    {
                      title: "Description of the selected area",
                      type: "bar-chart",
                      value: {
                        fields: [
                          "B03002_003E",
                          "B03002_012E",
                          "B03002_004E",
                          "B03002_006E",
                          "B03002_005E",
                          "B03002_007E",
                          "B03002_008E",
                          "B03002_008E",
                          "B03002_009E"
                        ],
                        tooltipField: "<field name>"
                      }
                    }
                  ]
                },
                {
                  type: "fields",
                }
              ],
              fieldInfos: [
                {
                  fieldName: "B03002_003E",
                  label: "Rain Occurance",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_012E",
                  label: "Heavy rain",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_004E",
                  label: "Moderate rain",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_006E",
                  label: "Light rain",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_005E",
                  label: "Traffic frequency",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_007E",
                  label: "Heavy traffic",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_008E",
                  label: "Moderate traffic",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  },
                },
                {
                  fieldName: "B03002_009E",
                  label: "Light traffic",
                  format: {
                    digitSeparator: true,
                    places: 0,
                  }
                }
              ]
            },
            renderer: dotDensityRenderer
          });

          map.add(layer);

          view.ui.add(
            [
              new Expand({
                view: view,
                content: new Legend({ view: view }),
                group: "top-left",
                expanded: true
              }),
              // new Expand({
              //   view: view,
              //   content: new Bookmarks({ view: view }),
              //   group: "top-left"
              // })
            ],
            "top-left"
          );
        });
      });
    </script>


    <!-- OTHER MAP -->
    <!-- <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/widgets/Legend",
        "esri/widgets/Slider",
        "esri/widgets/Expand"
      ], (Map, MapView, FeatureLayer, Legend, Slider, Expand
      ) => {
        // Configure clustering on the layer with a
        // popupTemplate displaying the predominant
        // fuel type of the power plants in the cluster
    
        const clusterLabelThreshold = 1500;
    
        const haloColor = "#373837";
        const color = "#f0f0f0";
    
        const clusterConfig = {
          type: "cluster",
          popupTemplate: {
            title: "Cluster summary",
            content: [
              {
                type: "text",
                text: `
                This cluster represents <b>{cluster_count}</b> power plants with an average capacity of <b>{cluster_avg_capacity_mw} megawatts</b>.
                 The power plants in this cluster produce a total of <b>{expression/total-mw} megawatts</b> of power.`
              },
              {
                type: "text",
                text: "Most power plants in this cluster generate power from <b>{cluster_type_fuel1}</b>."
              }
            ],
            fieldInfos: [{
              fieldName: "cluster_count",
              format: {
                places: 0,
                digitSeparator: true
              }
            }, {
              fieldName: "cluster_avg_capacity_mw",
              format: {
                places: 2,
                digitSeparator: true
              }
            }, {
              fieldName: "expression/total-mw",
              format: {
                places: 0,
                digitSeparator: true
              }
            }],
            expressionInfos: [{
              name: "total-mw",
              title: "total megawatts",
              expression: "$feature.cluster_avg_capacity_mw * $feature.cluster_count"
            }]
          },
          // larger radii look better with multiple label classes
          // smaller radii looks better visually
          clusterRadius: "120px",
          labelsVisible: true,
          labelingInfo: [{
            symbol: {
              type: "text",
              haloColor,
              haloSize: "1px",
              color,
              font: {
                family: "Noto Sans",
                size: "11px"
              },
              xoffset: 0,
              yoffset: "-15px",
            },
            labelPlacement: "center-center",
            labelExpressionInfo: {
              expression: "Text($feature.cluster_count, '#,### plants')"
            },
            where: `cluster_avg_capacity_mw > ${clusterLabelThreshold}`
          }, {
            symbol: {
              type: "text",
              haloColor,
              haloSize: "2px",
              color,
              font: {
                weight: "bold",
                family: "Noto Sans",
                size: "18px"
              },
              xoffset: 0,
              yoffset: 0
            },
            labelPlacement: "center-center",
            labelExpressionInfo: {
              expression: "$feature.cluster_type_fuel1"
            },
            where: `cluster_avg_capacity_mw > ${clusterLabelThreshold}`
          }, {
            symbol: {
              type: "text",
              haloColor,
              haloSize: "1px",
              color,
              font: {
                weight: "bold",
                family: "Noto Sans",
                size: "12px"
              },
              xoffset: 0,
              yoffset: "15px"
            },
            deconflictionStrategy: "none",
            labelPlacement: "center-center",
            labelExpressionInfo: {
              expression: `
              var value = $feature.cluster_avg_capacity_mw;
              var num = Count(Text(Round(value)));
    
              Decode(num,
                4, Text(value / Pow(10, 3), "##.0k"),
                5, Text(value / Pow(10, 3), "##k"),
                6, Text(value / Pow(10, 3), "##k"),
                7, Text(value / Pow(10, 6), "##.0m"),
                Text(value, "#,###")
              );
              `
            },
            where: `cluster_avg_capacity_mw > ${clusterLabelThreshold}`
          }, {
            symbol: {
              type: "text",
              haloColor,
              haloSize: "1px",
              color,
              font: {
                family: "Noto Sans",
                size: "11px"
              },
              xoffset: 0,
              yoffset: "-15px",
            },
            labelPlacement: "above-right",
            labelExpressionInfo: {
              expression: "Text($feature.cluster_count, '#,### plants')"
            },
            where: `cluster_avg_capacity_mw <= ${clusterLabelThreshold}`
          }, {
            symbol: {
              type: "text",
              haloColor,
              haloSize: "2px",
              color,
              font: {
                weight: "bold",
                family: "Noto Sans",
                size: "18px"
              }
            },
            labelPlacement: "above-right",
            labelExpressionInfo: {
              expression: "$feature.cluster_type_fuel1"
            },
            where: `cluster_avg_capacity_mw <= ${clusterLabelThreshold}`
          },  {
            symbol: {
              type: "text",
              haloColor,
              haloSize: "1px",
              color,
              font: {
                weight: "bold",
                family: "Noto Sans",
                size: "12px"
              },
              xoffset: 0,
              yoffset: 0
            },
            labelPlacement: "center-center",
            labelExpressionInfo: {
              expression: `
              var value = $feature.cluster_avg_capacity_mw;
              var num = Count(Text(Round(value)));
    
              Decode(num,
                4, Text(value / Pow(10, 3), "##.0k"),
                5, Text(value / Pow(10, 3), "##k"),
                6, Text(value / Pow(10, 3), "##k"),
                7, Text(value / Pow(10, 6), "##.0m"),
                Text(value, "#,###")
              );
              `
            },
            where: `cluster_avg_capacity_mw <= ${clusterLabelThreshold}`
          }]
        };
    
        const layer = new FeatureLayer({
          portalItem: {
            id: "eb54b44c65b846cca12914b87b315169"
          },
          featureReduction: clusterConfig,
          popupEnabled: true,
          labelsVisible: true,
          labelingInfo: [{
            symbol: {
              type: "text",
              haloColor,
              haloSize: "1px",
              color,
              font: {
                family: "Noto Sans",
                size: "11px"
              },
              xoffset: 0,
              yoffset: "-15px",
            },
            labelPlacement: "center-center",
            labelExpressionInfo: {
              expression: "$feature.name"
            },
            where: `capacity_mw > ${clusterLabelThreshold}`
          }, {
            symbol: {
              type: "text",
              haloColor,
              haloSize: "2px",
              color,
              font: {
                weight: "bold",
                family: "Noto Sans",
                size: "18px"
              },
              xoffset: 0,
              yoffset: 0
            },
            labelPlacement: "center-center",
            labelExpressionInfo: {
              expression: "$feature.fuel1"
            },
            where: `capacity_mw > ${clusterLabelThreshold}`
          }, {
            symbol: {
              type: "text",
              haloColor,
              haloSize: "1px",
              color,
              font: {
                weight: "bold",
                family: "Noto Sans",
                size: "12px"
              },
              xoffset: 0,
              yoffset: "15px"
            },
            labelPlacement: "center-center",
            labelExpressionInfo: {
              expression: `
              var value = $feature.capacity_mw;
              var num = Count(Text(Round(value)));
    
              Decode(num,
                4, Text(value / Pow(10, 3), "##.0k"),
                5, Text(value / Pow(10, 3), "##k"),
                6, Text(value / Pow(10, 3), "##k"),
                7, Text(value / Pow(10, 6), "##.0m"),
                Text(value, "#,###")
              );
              `
            },
            where: `capacity_mw > ${clusterLabelThreshold}`
          }, {
            symbol: {
              type: "text",
              haloColor,
              haloSize: "1px",
              color,
              font: {
                family: "Noto Sans",
                size: "11px"
              },
              xoffset: 0,
              yoffset: "-15px",
            },
            labelPlacement: "above-right",
            labelExpressionInfo: {
              expression: "$feature.name"
            },
            where: `capacity_mw <= ${clusterLabelThreshold}`
          }, {
            symbol: {
              type: "text",
              haloColor,
              haloSize: "2px",
              color,
              font: {
                weight: "bold",
                family: "Noto Sans",
                size: "18px"
              }
            },
            labelPlacement: "above-right",
            labelExpressionInfo: {
              expression: "$feature.fuel1"
            },
            where: `capacity_mw <= ${clusterLabelThreshold}`
          }, {
            symbol: {
              type: "text",
              haloColor,
              haloSize: "1px",
              color,
              font: {
                weight: "bold",
                family: "Noto Sans",
                size: "12px"
              },
              xoffset: 0,
              yoffset: 0
            },
            labelPlacement: "center-center",
            labelExpressionInfo: {
              expression: `
              var value = $feature.capacity_mw;
              var num = Count(Text(Round(value)));
    
              Decode(num,
                4, Text(value / Pow(10, 3), "##.0k"),
                5, Text(value / Pow(10, 3), "##k"),
                6, Text(value / Pow(10, 3), "##k"),
                7, Text(value / Pow(10, 6), "##.0m"),
                Text(value, "#,###")
              );
              `
            },
            where: `capacity_mw <= ${clusterLabelThreshold}`
          }]
        });
    
        const map = new Map({
          basemap: {
            portalItem: {
              id: "8d91bd39e873417ea21673e0fee87604"
            }
          },
          layers: [layer]
        });
    
        const view = new MapView({
          container: "otherDiv",
          map: map,
          extent: {
            spatialReference: {
              latestWkid: 3857,
              wkid: 102100
            },
            xmin: -42087672,
            ymin: 4108613,
            xmax: -36095009,
            ymax: 8340167
          }
        });
    
        layer.when().then(() =>{
          const renderer = layer.renderer.clone();
          renderer.visualVariables = [{
            type: "size",
            field: "capacity_mw",
            legendOptions: {
              title: "Capacity (MW)"
            },
            minSize: "24px",
            maxSize: "100px",
            minDataValue: 1,
            maxDataValue: 5000
          }];
          layer.renderer = renderer;
        });
    
        const legend = new Legend({
          view: view,
          container: "legendDiv"
        });
    
        const infoDiv = document.getElementById("infoDiv");
        view.ui.add(
          new Expand({
            view: view,
            content: infoDiv,
            expandIconClass: "esri-icon-layer-list",
            expanded: true
          }),
          "top-right"
        );
    
        view.whenLayerView(layer).then((layerView) => {
          const field = "capacity_mw";
    
          const slider = new Slider({
            min: 0,
            max: 2000,
            values: [0],
            container: document.getElementById("sliderDiv"),
            visibleElements: {
              rangeLabels: true
            },
            precision: 0
          });
    
          const sliderValue = document.getElementById("sliderValue");
    
          // filter features by power plant capacity when the user
          // drags the slider thumb. If clustering is enabled,
          // clusters will recompute and render based on the number
          // and type of features that satisfy the filter where clause
    
          slider.on(["thumb-change", "thumb-drag"], (event) => {
            sliderValue.innerText = event.value;
            layerView.filter = {
              where: field + " >= " + event.value
            };
          });
        });
      });
    </script> -->

<!-- OTHER MAP -->
<script>
  require([
    "esri/views/MapView",
    "esri/WebMap",
    "esri/widgets/Legend",
    "esri/widgets/Expand",
    "esri/widgets/Bookmarks",
    "esri/core/lang",
    "esri/core/promiseUtils",
    "esri/core/reactiveUtils"
  ], (MapView, WebMap, Legend, Expand, Bookmarks, lang, promiseUtils, reactiveUtils) => {
    // declare chart variables to update as the under interacts with the sample

    let yearChart, ageChart, dispositionChart, genderChart, raceChart, totalNumber, avgAge, avgOpenTime;

    // load a web map containing homicide statistics
    // from a portal item

    const webmap = new WebMap({
      portalItem: {
        id: "96cf806c32874026bef5f586315f098c"
      }
    });

    const view = new MapView({
      map: webmap,
      container: "viewDivB",
      constraints: {
        minScale: 300000
      },
      highlightOptions: {
        color: "black",
        haloOpacity: 0.65,
        fillOpacity: 0.45
      }
    });


    const titleContent = document.createElement("div");
    titleContent.style.padding = "15px";
    titleContent.style.backgroundColor = "white";
    titleContent.style.width = "500px";
    titleContent.innerHTML = [

    ].join(" ");

    const titleExpand = new Expand({
      expandIconClass: "esri-icon-dashboard",
      expandTooltip: "Summary stats",
      view: view,
      content: titleContent,
      expanded: view.widthBreakpoint !== "xsmall"
    });

    const legendExpand = new Expand({
      view: view,
      content: new Legend({
        view: view
      }),
      expanded: view.widthBreakpoint !== "xsmall"
    });

    view.watch("widthBreakpoint", (newValue) => {
      titleExpand.expanded = newValue !== "xsmall";
      legendExpand.expanded = newValue !== "xsmall";
    });

    const bookmarksWidget = new Bookmarks({
      view: view
    });

    const bookmarksExpand = new Expand({
      view: view,
      content: bookmarksWidget
    });

    bookmarksWidget.on("select-bookmark", (event) => {
      bookmarksExpand.expanded = true;
    });

    // Displays instructions to the user for understanding the sample
    // And places them in an Expand widget instance

    const sampleInstructions = document.createElement("div");
    sampleInstructions.style.padding = "10px";
    sampleInstructions.style.backgroundColor = "white";
    sampleInstructions.style.width = "300px";
    sampleInstructions.innerHTML = [
    ].join(" ");

    const instructionsExpand = new Expand({
      expandIconClass: "esri-icon-question",
      expandTooltip: "How to use this sample",
      view: view,
      content: sampleInstructions
    });
    view.ui.add(instructionsExpand, "top-left");

    let highlightHandle = null;

    /**
     * Create charts and start querying the layer view when
     * the view is ready and data begins to draw in the view
     */
    view.when().then(() => {
      // Create the charts when the view is ready
      createCharts();

      const layer = webmap.layers.getItemAt(0);
      layer.outFields = [ "victim_age_years", "victim_race", "victim_sex", "reported_year", "disposition", "milliseconds" ];

      view.whenLayerView(layer).then((layerView) => {
        reactiveUtils
          .whenOnce(() => !layerView.updating)
          .then(() => {
            // Query layer view statistics as the user clicks
            // or drags the pointer across the view.
            view.on(["click", "drag"], (event) => {
              // disables navigation by pointer drag
              event.stopPropagation();
              queryStatsOnDrag(layerView, event)
                .then(updateCharts)
                .catch((error) => {
                  if (error.name !== "AbortError") {
                    console.error(error);
                  }
                });
            });
          });
      });
    });

    /**
     * Queries statistics against the layer view at the given screen location
     */
    const queryStatsOnDrag = promiseUtils.debounce((layerView, event) => {
      // create a query object for the highlight and the statistics query

      const query = layerView.layer.createQuery();
      query.geometry = view.toMap(event); // converts the screen point to a map point
      query.distance = 1; // queries all features within 1 mile of the point
      query.units = "miles";

      const statsQuery = query.clone();

      // date used to calculate the average time a case has been opened

      const dataDownloadDate = Date.UTC(2018, 6, 5);

      // Create the statistic definitions for querying stats from the layer view
      // the `onStatisticField` property can reference a field name or a SQL expression
      // `outStatisticFieldName` is the name of the statistic you will reference in the result
      // `statisticType` can be sum, avg, min, max, count, stddev
      const statDefinitions = [
        // Age of crime since it was reported in years

        {
          onStatisticField: "(" + dataDownloadDate + " - milliseconds) / (1000 * 60 * 60 * 24 * 365.25)",
          outStatisticFieldName: "avg_open_time_years",
          statisticType: "avg"
        },

        // total homicides

        {
          onStatisticField: "1",
          outStatisticFieldName: "total",
          statisticType: "count"
        },

        // total homicides by year
        //
        // Since separate fields don't exist for each year, we can use
        // an expression to return a 1 or a 0 for each year and sum up the
        // results to get the total.

        {
          onStatisticField: "CASE WHEN reported_year = 2008 THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_2008",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN reported_year = 2009 THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_2009",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN reported_year = 2010 THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_2010",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN reported_year = 2011 THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_2011",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN reported_year = 2012 THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_2012",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN reported_year = 2013 THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_2013",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN reported_year = 2014 THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_2014",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN reported_year = 2015 THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_2015",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN reported_year = 2016 THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_2016",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN reported_year = 2017 THEN 1 ELSE 0 END",
          outStatisticFieldName: "total_2017",
          statisticType: "sum"
        },

        // crime disposition (aka crime statu)
        //
        // Since this is a string field, we can use a similar technique to sum
        // the total of each status of the crime

        {
          onStatisticField: "CASE WHEN disposition = 'Closed by arrest' THEN 1 ELSE 0 END",
          outStatisticFieldName: "num_closed_arrest",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN disposition = 'Open/No arrest' THEN 1 ELSE 0 END",
          outStatisticFieldName: "num_open",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN disposition = 'Closed without arrest' THEN 1 ELSE 0 END",
          outStatisticFieldName: "num_closed_no_arrest",
          statisticType: "sum"
        },

        // average victim age
        //
        // Some victim ages are unknown and indicated with a -99. We'll
        // use an expression to treat those unknown ages as 0. This will
        // skew the average age slightly downward since we can't exclude those
        // values without a where clause. Do use a where clause, we could execute
        // a separate query

        {
          onStatisticField: "CASE WHEN victim_age_years = -99 THEN 0 ELSE victim_age_years END",
          outStatisticFieldName: "avg_age",
          statisticType: "avg"
        },

        // victim age brackets

        {
          onStatisticField: "CASE WHEN victim_age_years = -99 THEN 1 ELSE 0 END",
          outStatisticFieldName: "age_unknown",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN victim_age_years >= 0 AND victim_age_years <= 18 THEN 1 ELSE 0 END",
          outStatisticFieldName: "age_18_under",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN victim_age_years >= 19 AND victim_age_years <= 30 THEN 1 ELSE 0 END",
          outStatisticFieldName: "age_19_30",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN victim_age_years >= 31 AND victim_age_years <= 44 THEN 1 ELSE 0 END",
          outStatisticFieldName: "age_31_44",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN victim_age_years >= 45 AND victim_age_years <= 65 THEN 1 ELSE 0 END",
          outStatisticFieldName: "age_45_64",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN victim_age_years >= 65 THEN 1 ELSE 0 END",
          outStatisticFieldName: "age_65_over",
          statisticType: "sum"
        },

        // victim gender

        {
          onStatisticField: "CASE WHEN victim_sex = 'Male' THEN 1 ELSE 0 END",
          outStatisticFieldName: "num_males",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN victim_sex = 'Female' THEN 1 ELSE 0 END",
          outStatisticFieldName: "num_females",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN victim_sex = 'Unknown' THEN 1 ELSE 0 END",
          outStatisticFieldName: "num_unknown_gender",
          statisticType: "sum"
        },

        // victim race

        {
          onStatisticField: "CASE WHEN victim_race = 'Asian' THEN 1 ELSE 0 END",
          outStatisticFieldName: "num_asian",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN victim_race = 'Black' THEN 1 ELSE 0 END",
          outStatisticFieldName: "num_black",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN victim_race = 'Hispanic' THEN 1 ELSE 0 END",
          outStatisticFieldName: "num_hispanic",
          statisticType: "sum"
        },
        {
          onStatisticField: "CASE WHEN victim_race = 'White' THEN 1 ELSE 0 END",
          outStatisticFieldName: "num_white",
          statisticType: "sum"
        }
      ];

      // add the stat definitions to the the statistics query object cloned earlier
      statsQuery.outStatistics = statDefinitions;

      // execute the query for all features in the layer view
      const allStatsResponse = layerView.queryFeatures(statsQuery).then(
        (response) => {
          const stats = response.features[0].attributes;
          return stats;
        },
        (e) => {
          console.error(e);
        }
      );

      const openStatsQuery = statsQuery.clone();
      openStatsQuery.where = "disposition = 'Open/No arrest'";

      // execute the query for only unsolved homicides in the layer view
      const unsolvedStatsResponse = layerView.queryFeatures(openStatsQuery).then(
        (response) => {
          const stats = response.features[0].attributes;
          return stats;
        },
        (e) => {
          console.error(e);
        }
      );

      // highlight all features within the query distance
      layerView.queryObjectIds(query).then((ids) => {
        if (highlightHandle) {
          highlightHandle.remove();
          highlightHandle = null;
        }
        highlightHandle = layerView.highlight(ids);
      });

      // Return the promises that will resolve to each set of statistics
      return promiseUtils.eachAlways([allStatsResponse, unsolvedStatsResponse]);
    });

    /**
     * Updates the charts with the data returned from the statistic queries.
     */
    function updateCharts(responses) {
      const allStats = responses[0].value;
      const unsolvedStats = responses[1].value;

      const yearChartStats = {
        solved: [
          allStats.total_2008 - unsolvedStats.total_2008,
          allStats.total_2009 - unsolvedStats.total_2009,
          allStats.total_2010 - unsolvedStats.total_2010,
          allStats.total_2011 - unsolvedStats.total_2011,
          allStats.total_2012 - unsolvedStats.total_2012,
          allStats.total_2013 - unsolvedStats.total_2013,
          allStats.total_2014 - unsolvedStats.total_2014,
          allStats.total_2015 - unsolvedStats.total_2015,
          allStats.total_2016 - unsolvedStats.total_2016,
          allStats.total_2017 - unsolvedStats.total_2017
        ],
        unsolved: [
          unsolvedStats.total_2008,
          unsolvedStats.total_2009,
          unsolvedStats.total_2010,
          unsolvedStats.total_2011,
          unsolvedStats.total_2012,
          unsolvedStats.total_2013,
          unsolvedStats.total_2014,
          unsolvedStats.total_2015,
          unsolvedStats.total_2016,
          unsolvedStats.total_2017
        ]
      };
      updateChart(yearChart, yearChartStats);

      const ageChartStats = {
        solved: [
          allStats.age_65_over - unsolvedStats.age_65_over,
          allStats.age_45_64 - unsolvedStats.age_45_64,
          allStats.age_31_44 - unsolvedStats.age_31_44,
          allStats.age_19_30 - unsolvedStats.age_19_30,
          allStats.age_18_under - unsolvedStats.age_18_under,
          allStats.age_unknown - unsolvedStats.age_unknown
        ],
        unsolved: [
          unsolvedStats.age_65_over,
          unsolvedStats.age_45_64,
          unsolvedStats.age_31_44,
          unsolvedStats.age_19_30,
          unsolvedStats.age_18_under,
          unsolvedStats.age_unknown
        ]
      };
      updateChart(ageChart, ageChartStats);

      const dispositionStats = [allStats.num_closed_arrest, allStats.num_closed_no_arrest, allStats.num_open];
      updateChart(dispositionChart, dispositionStats);

      const genderStats = [
        allStats.num_males - unsolvedStats.num_males,
        unsolvedStats.num_males,
        allStats.num_females - unsolvedStats.num_females,
        unsolvedStats.num_females
      ];
      updateChart(genderChart, genderStats);

      const raceStats = [
        allStats.num_asian - unsolvedStats.num_asian,
        unsolvedStats.num_asian,
        allStats.num_black - unsolvedStats.num_black,
        unsolvedStats.num_black,
        allStats.num_hispanic - unsolvedStats.num_hispanic,
        unsolvedStats.num_hispanic,
        allStats.num_white - unsolvedStats.num_white,
        unsolvedStats.num_white
      ];
      updateChart(raceChart, raceStats);

      // Update the total numbers in the title UI element
      avgAge.innerHTML = Math.round(allStats.avg_age);
      totalNumber.innerHTML = allStats.total;
      avgOpenTime.innerHTML = unsolvedStats.avg_open_time_years.toFixed(1);
    }

    /**
     * Updates the given chart with new data
     */
    function updateChart(chart, dataValues) {
      if (chart.config.type === "doughnut") {
        chart.data.datasets[0].data = dataValues;
      } else {
        chart.data.datasets[0].data = dataValues.solved;
        chart.data.datasets[1].data = dataValues.unsolved;
      }
      chart.update();
    }

    /**
     * Creates 5 charts for summarizing homicide data
     */
    function createCharts() {
      totalNumber = document.getElementById("num-homicides");
      avgAge = document.getElementById("avg-age");
      avgOpenTime = document.getElementById("avg-open-time");

      const yearCanvas = document.getElementById("year-chart");
      yearChart = new Chart(yearCanvas.getContext("2d"), {
        type: "bar",
        data: {
          labels: ["2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016", "2017"],
          datasets: [
            {
              label: "Active Contamination",
              backgroundColor: "#E6E6FA",
              stack: "Stack 0",
              data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            },
            {
              label: "Passive Contamination",
              backgroundColor: "#CCCCFF",
              stack: "Stack 0",
              data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
            }
          ]
        },
        options: {
          responsive: false,
          legend: {
            position: "top"
          },
          title: {
            display: true,
            text: "Water Contamination"
          },
          scales: {
            xAxes: [
              {
                stacked: true
              }
            ],
            yAxes: [
              {
                stacked: true,
                ticks: {
                  beginAtZero: true
                }
              }
            ]
          }
        }
      });

      const ageCanvas = document.getElementById("age-chart");
      ageChart = new Chart(ageCanvas.getContext("2d"), {
        type: "horizontalBar",
        data: {
          labels: ["65+", "45-64", "31-44", "18-30", "0-18", "Not sure"],
          datasets: [
            {
              label: "Active Contamination",
              backgroundColor: "#E6E6FA",
              stack: "Stack 0",
              data: [0, 0, 0, 0, 0, 0]
            },
            {
              label: "Passive Contamination",
              backgroundColor: "#CCCCFF",
              stack: "Stack 0",
              data: [0, 0, 0, 0, 0, 0]
            }
          ]
        },
        options: {
          responsive: false,
          legend: {
            position: "top"
          },
          title: {
            display: false,
            text: "Effects of Contamination by age"
          },
          scales: {
            xAxes: [
              {
                stacked: true,
                ticks: {
                  beginAtZero: true
                }
              }
            ],
            yAxes: [
              {
                stacked: true
              }
            ]
          }
        }
      });

      const dispositionCanvas = document.getElementById("disposition-chart");
      dispositionChart = new Chart(dispositionCanvas.getContext("2d"), {
        type: "doughnut",
        data: {
         
          datasets: [
            {
              backgroundColor: ["#FFFFFF", "#FFFFFF", "#FFFFFF"],
              borderColor: "#FFFFFF",
              borderWidth: 1,
              data: [0, 0, 0]
            }
          ]
        },
        options: {
          responsive: false,
          cutoutPercentage: 35,
          legend: {
            position: "bottom"
          },
          title: {
            display: false,
            text: "Status of the case"
          }
        }
      });

      const genderCanvas = document.getElementById("gender-chart");
      genderChart = new Chart(genderCanvas.getContext("2d"), {
        type: "doughnut",
        data: {
          
        },
        options: {
          responsive: false,
          cutoutPercentage: 35,
          legend: {
            position: "bottom"
          },
          title: {
            display: false,
            text: "Gender of the victim"
          }
        }
      });

      const raceCanvas = document.getElementById("race-chart");
      raceChart = new Chart(raceCanvas.getContext("2d"), {
        type: "doughnut",
        data: {
        
          datasets: [
         
          ]
        },
        options: {
          responsive: false,
          cutoutPercentage: 35,
          legend: {
            position: "bottom"
          },
          title: {
            display: false,
            text: "Race of the victim"
          }
        }
      });
    }
  });
</script>


  </head>

  <body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-dark bg-custom">
      <a class="navbar-brand mb-0 h1">RAIN : GOOD OR EVIL? (GEOSPATIAL WITH CUSTOMISABLE GLYPHS)</a>
    </nav>
  
  <!-- MAIN DIV ROW   -->
  <div class="container main">
    <div class="row">
      <!-- TABLE -->
      <div class="col-lg-4 tablestuff">
        <table class="table table-hover">
          <thead>
            <tr>
              <th scope="col">FILTER</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" >
                    <label class="form-check-label" for="flexCheckDefault">
                      Pedestrian Traffic
                    </label>
                  </div>
              </td>
            </tr>
            <tr>
              <td>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" >
                    <label class="form-check-label" for="flexCheckDefault">
                      Working Hours of Shops
                    </label>
                  </div>
              </td>
              
            </tr>
            <tr>
              <td>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" >
                    <label class="form-check-label" for="flexCheckDefault">
                      Daily Income
                    </label>
                  </div>
              </td>
            
            </tr>
            <tr>
                <td>
                  <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" >
                      <label class="form-check-label" for="flexCheckDefault">
                        Water Scarcity
                      </label>
                    </div>
                </td>
              
              </tr>
              <tr>
                <td>
                  <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" >
                      <label class="form-check-label" for="flexCheckDefault">
                        Water Contamination
                      </label>
                    </div>
                </td>
              
              </tr>
              <tr>
                <td>
                  <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" >
                      <label class="form-check-label" for="flexCheckDefault">
                        Groundwater Level
                      </label>
                    </div>
                </td>
              
              </tr>
              <tr>
                <td>
                  <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" >
                      <label class="form-check-label" for="flexCheckDefault">
                        Temperature
                      </label>
                    </div>
                </td>
              
              </tr>
              <tr>
                <td>
                  <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" >
                      <label class="form-check-label" for="flexCheckDefault">
                        Wind Speed
                      </label>
                    </div>
                </td>
              
              </tr>
              <tr>
                <td>
                  <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" >
                      <label class="form-check-label" for="flexCheckDefault">
                        Vehicle Traffic
                      </label>
                    </div>
                </td>
              
              </tr>
              <tr>
                <td>
                  <div class="form-check">
                      <input class="form-check-input" type="checkbox" value="" id="flexCheckDefault" >
                      <label class="form-check-label" for="flexCheckDefault">
                        Flight Timing
                      </label>
                    </div>
                </td>
              
              </tr>
              
          </tbody>
        </table>
      </div>

      <div class="col-lg-8">

      <!-- MAP -->
        <div id="viewDiv"></div>
      <!-- OTHER MAP -->
        <!-- <div id="otherDiv"></div>
        <div id="infoDiv" class="esri-widget">
          <div id="description">
            Show power plants with at least <span id="sliderValue">0</span> megawatts of capacity
          </div>
          <div id="sliderContainer">
            <div id="sliderDiv"></div>
          </div>
          <div id="legendDiv"></div>
        </div>
    </div> -->
  </div>   
  
  <!-- NEXT MAIN -->
  <div class="main2">
    <div class="row row2">
      
      <!-- BUTTONS -->
      <div class="col-lg-2 btncol">
        <button class="coolbtn">Last Day</button>
        <button class="coolbtn">Contamination</button>
      </div>
      <div class="col-lg-2 btncol">
        <button class="coolbtn">Next Day</button>
        <button class="coolbtn">Other</button>
      </div>

      <!-- CARDS -->
      <div class="col-lg-2">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Max. Temp.</h5>
              <h3 class="card-text">93F</h3>
            </div>
          </div>
      </div>
      <div class="col-lg-2">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Min. Temp.</h5>
              <h3 class="card-text">50F</h3>
            </div>
          </div>
      </div>
      <div class="col-lg-2">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Max. Rainfall</h5>
              <h3 class="card-text">27cm</h3>
            </div>
          </div>  
      </div>
      <div class="col-lg-2">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title">Wind Speed</h5>
            <h3 class="card-text">2mph</h3>
          </div>
        </div>
      </div> 
    </div>
  </div>

  <!-- NEW MAP  -->
  <div class="container newMap">
    <div id="viewDivB"></div>
    <div id="panel">
      <div style="padding: 15px;">
        <canvas id="year-chart" height="250" width="550"></canvas>
        <canvas id="age-chart" height="250" width="550"></canvas>
        <canvas id="disposition-chart" width="200" height="350" style="float:left;"></canvas>
        <canvas id="gender-chart" width="200" height="350" style="float:left;"></canvas>
        <canvas id="race-chart" width="200" height="350" style="float:left;"></canvas>
      </div>
    </div>
  </div>

  <script src="index.js" charset="utf-8"></script>
  </body>
</html>
